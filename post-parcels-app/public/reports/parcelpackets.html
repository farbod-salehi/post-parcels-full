<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <title> مرسوله‌های بسته</title>
    <style>
        body {
            padding: 0px;
            margin: 0px;
            font-family: Vazir;
            direction: rtl;
        }
    
        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
        }
    
        thead {
            font-weight: bold;
        }

        tbody {
            font-size: 0.8em;
        }
    
        @font-face {
            font-family: 'Vazir';
            src: url('fonts/Vazir.eot');
            src: url('fonts/Vazir.eot?#iefix') format('embedded-opentype');
            src: url('fonts/Vazir.woff') format('woff');
            src: url('fonts/Vazir.ttf') format('truetype');
        }
    </style>
    <script>
        const queryParams = (new URL(document.location)).searchParams;
        const paramsObject = undefined;
        const method = 'GET';
        const requestAPI = queryParams.get('requestAPI');
        const authInfo = localStorage.getItem('authInfo');
        const jwt = JSON.parse(authInfo).userToken;

        const items = [];

        fetch(requestAPI, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${jwt}`,
            },
            body: JSON.stringify(paramsObject),
        })
            .then(async function (response) {
                if (response.ok) {
                    return response.json(); // will return data as json. it will be catched in the next 'then()'
                } else {
                    const errorResponse = await response.json();
                    throw new Error(
                        JSON.stringify({
                            ...errorResponse.error,
                            ...{ message: errorResponse.message },
                        })
                    ); // by this line, error will be catched in 'catch()' block
                }
            })
            .then(function (result) {
                 document.querySelector('#parcel-code').innerHTML = result.code;
                 const packets = [];
                 result.list.sort((a, b) => (a.packetNumber - b.packetNumber)).forEach(element => {
                    if(packets.includes(element.packetNumber) === false) {
                        packets.push(element.packetNumber);
                    }
                    items.push({
                        packetNumber: element.packetNumber,
                        code: element.code,
                        description: element.description ?? "---" ,
                        senderTitle: element.undefinedSenderTitle === null ? element.senderTitle : element.undefinedSenderTitle,
                        receiverTitle: element.undefinedReceiverTitle === null ? element.receiverTitle : element.undefinedReceiverTitle,
                        typeFa: element.typeName,

                    });
                    document.querySelector('#packet-count').innerHTML = packets.length;
                 });
                
                 let output = '';
                 packets.forEach(packNumber => {
                    const packetItems = items.filter(x=>x.packetNumber === packNumber);
                    let packetRows = '';
                    let firstReceiver = packetItems.length > 0 ? packetItems[0].receiverTitle : "";
                    packetItems.forEach((packetItem, index) => {
                        packetRows += `<tr> 
                                            <td> ${index + 1} </td> 
                                            <td style="direction:ltr"> ${packetItem.code} </td> 
                                            <td> ${packetItem.typeFa} </td> 
                                            <td> ${packetItem.description} </td>
                                            <td> ${packetItem.senderTitle} </td> 
                                            <td> ${packetItem.receiverTitle} </td>  
                                       </tr>`;
                    });
                    
                    output += ` <div style="margin: 20px auto 0px auto; width: 95%; text-align: right; font-weight:bold">  
                                        بسته شماره
                                        ${packNumber} 
                                        &nbsp;
                                        |
                                        &nbsp;
                                        ${firstReceiver}
                                </div>
                                <table style="margin: 5px auto; width: 95%; text-align: center;"> 
                                     <thead>
                                      
                                        <tr> 
                                             <td>
                                                ردیف
                                            </td>
                                            <td>
                                                شماره 
                                            </td>
                                            <td>
                                                نوع
                                            </td>
                                            <td>
                                               توضیحات
                                            </td>
                                          
                                            <td>
                                                فرستنده
                                            </td>
                                            <td>
                                                گیرنده
                                            </td>
                                        </tr>
                                     </thead> 
                                     <tbody>                                     
                                        ${packetRows}
                                     </tbody>
                                </table>
                                <div style="border-bottom:3px dashed gray; width:95%; margin:20px auto 0px auto;">  </div>
                                `;
                 });

               
                 document.querySelector('#content').innerHTML = output;

                 window.print();
            })
            .catch(function (error) {
                console.log(error);
            });

            
    </script>
    
</head>

<body>
    <noscript>
        لطفا جاوااسکریپت را روی مرورگر فعال کنید.
    </noscript>
    <div style="text-align: center; padding: 30px 0px; font-weight: bold; font-size: 20px;">
         پکیج 
       
        <span id="parcel-code"></span>
    </div>
    <div style="text-align:left; width: 96%; color: gray; font-size: 0.85em; font-weight: bold;">
        تعداد بسته‌ها:
        <span id="packet-count"> </span>
    </div>
    <div id="content">

    </div>
</body>

</html>


